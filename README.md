# BGP
 
**Терминология протокола**

**BGP (Border Gateway Protocol)** — это основной протокол динамической маршрутизации, который используется в Интернете. Протокол BGP предназначен для обмена информацией о достижимости подсетей между автономными системами.

**Внутренний протокол маршрутизации (interior gateway protocol, IGP)** – протокол, который используется для передачи информации о маршрутах внутри автономной системы.

**Внешний протокол маршрутизации (exterior gateway protocol, EGP)** – протокол, который используется для передачи информации о маршрутах между автономными системами.

**Автономная система (autonomous system, AS)** — набор маршрутизаторов, имеющих единые правила маршрутизации, управляемых одной технической администрацией и работающих на одном из протоколов IGP (для внутренней маршрутизации AS может использовать и несколько IGP). Подробнее можно почитать, например, тут.

**Транзитная автономная система (transit AS)** — автономная система, через которую передается трафик других автономных систем.

**Путь (path)** — последовательность состоящая из номеров автономных систем через которые нужно пройти для достижения сети назначения.

**Соседи (neighbor, peer)** — любые два маршрутизатора, между которыми открыто TCP-соединение для обмена информацией о маршрутизации.

**Внутренний BGP (Internal BGP, iBGP)** — BGP работающий внутри автономной системы. iBGP-соседи не обязательно должны быть непосредственно соединены.

**Внешний BGP (External BGP, eBGP)** — BGP работающий между автономными системами. По умолчанию, eBGP-соседи должны быть непосредственно соединены.
Если iBGP-маршрутизаторы работают в нетранзитной AS, то соединение между ними должно быть full mesh. Это следствие принципов работы протокола — если маршрутизатор, находящийся на границе AS, получил обновление, то он передает его всем соседям; соседи, которые находятся внутри автономной системы, больше это обновление не распространяют, так как считают, что все соседи внутри AS уже его получили.
 
**Настройка**

Рассмотрим следующую схему. На ней мы имеем 4 маршрутизатора в одной автономной системе (между ними настроен протокол OSPF) и еще 1 маршрутизатор, находящийся за ее пределами. Поверх системы с OSPF будет мы будем настраивать iBGP, а от нее к отдельно стоящему роутеру настроем eBGP. Также, подразумеваем, что за AS 50002 находится сеть 10.2.0.0/16.
 
 ![Схема](https://sun9-9.userapi.com/c855420/v855420567/1d4fdf/D5R67pT8j9Q.jpg)
 
1. Создание Loopback-интерфейсов 
После настройки IP-адресов на интерфейсах и OSPF-маршрутизации между роутерами, на каждом роутере создаем еще Loopback интерфейс и настраиваем на нем OSPF. Например, вот так это делалось на OSPF69.
 
![Пример](https://sun9-36.userapi.com/c855420/v855420567/1d4fe7/MC3C54niGAM.jpg) 

Используемые команды:

```
Router# conf t
Router(config)# int loopback 0
Router(config-int)# ip address <адрес> <маска>
Router(config)# exit
Router(config-router)# router ospf <номер процесса>
Router(config-router)# network <адрес> <обратная маска>area<номер зоны>
```

На каждом роутере появился подобный интерфейс, который будет Router ID для OSPF и BGP.
Как правило, IBGP «натягивается» поверх существующего на сети IGP. IGP обеспечивает связность всех маршрутизаторов между собой по IP, быструю реакцию на изменения в топологии и перенос маршрутной информации о внутренних сетях.
С помощью команды sh ip route ospf сейчас мы можем видеть все маршруты. Например, маршруты для роутера OSPF69 приведены ниже. Мы видим, что сети 10.2.0.0/16 там нет и не должно быть.
 
 ![ospf](https://sun9-64.userapi.com/c855420/v855420567/1d4fef/pzK30xVXl7I.jpg)
 
Перейдем к настройке BGP.
2. EBGP
Для начала настроим связь между двумя АС. Для этого совершим настройки eBGP на роутерах OSPF71 и Router.
EBGP – это обычный BGP между автономными системами. Для его настройки необходимо всего несколько команд. 
ASN – номер автономной системы. Для лабораторных работ его берем из головы, однако, в реальной практике он выдается специальной организацией - LIR.

```
Router(config)#router bgp <ASN>
Router(config-router)#neighbor <ip-адрес соседа> remote-as <ASN соседа>
Router(config-router)#network <адрес сети, которая находится в данной АС> mask <маска>
Router(config)#ip route <адрес сети, которая находится в данной АС> <маска> Null0
```

На роутере Router:

![Роутер](https://sun9-25.userapi.com/c855420/v855420567/1d4ff7/BH8S1d0pqWo.jpg)

![ip route](https://sun9-7.userapi.com/c855420/v855420567/1d4ffe/j7JX3Fr9898.jpg)
 
Если всё прописано верно, мы можем увидеть на каждом из роутеров сообщения вроде этого:

```
*Jan 26 16:48:21.973: %BGP-5-ADJCHANGE: neighbor 100.100.100.2 Up
```

При помощи команды sh ip bgp мы можем просмотреть BGP-таблицу. 

![ip bgp](https://sun9-22.userapi.com/c855420/v855420567/1d5006/UKQH_W-iqfA.jpg)
 
Проверим, идет ли ping между данными роутерами. Выполним следующую команду на OSPF71:

![ping](https://sun9-56.userapi.com/c855420/v855420567/1d500e/5qZKGLkuA0Y.jpg)
 
3. IBGP
Перейдем к настройке BGP протокола внутри AS 50001. На всех роутерах внутри нее проделаем следующие команды:

```
Router(config)#router bgp <ASN>
Router(config-router)#network <адрес сети, которая находится в данной АС> mask <маска>
Router(config-router)#neighbor 2.2.2.2 remote-as <ASN>
Router(config-router)#neighbor 2.2.2.2 update-source Loopback0
Router(config-router)#neighbor 3.3.3.3 remote-as <ASN>
Router(config-router)#neighbor 3.3.3.3 update-source Loopback0
Router(config-router)#neighbor 4.4.4.4 remote-as <ASN>
Router(config-router)#neighbor 4.4.4.4 update-source Loopback0
```

Команда вида neighbor 2.2.2.2 remote-as 50001 объявляет соседа и сообщает, что он находится в AS 50001, BGP понимает, что это та же AS, в которой он сам работает и далее считает 2.2.2.2 своим IBGP-партнёром.
Команда вида neighbor 2.2.2.2 update-source Loopback0 сообщает, что соединение будет устанавливаться с адреса интерфейса Loopback. Дело в том, что на другой стороне (на 2.2.2.2) сосед настроен, как 1.1.1.1 и именно с этого адреса ждёт все BGP-сообщения.
То есть, мы объявляем соседями все Loopback-интерфейсы, которые имеются в нашей АС, кроме того, который находится на данном роутере. Например, для OSPF69 это выглядит следующим образом:

![Config](https://sun9-10.userapi.com/c855420/v855420567/1d5015/DtUSd5jlmMY.jpg)

Теперь наша АС знает о том, что есть еще одна подсеть. Однако, соединения еще нет. На каждом роутере, для каждого loopback-интерфейса прописываем следующую команду:
Router(config-router)#neighbor 2.2.2.2 Next-Hop-self
На OSPF71 это будет выглядеть так:

![Next hop](https://sun9-72.userapi.com/c855420/v855420567/1d501d/0zYpWM1ykEA.jpg)
 
Теперь мы можем увидеть, например, для OSPF69, следующую картину:

![ospf69](https://sun9-52.userapi.com/c855420/v855420567/1d5025/K3aW_JIPpXA.jpg)
 
Проверяем с него ping на адреса интерфейсов Router, которые не подключены к остальным:

![ping](https://sun9-61.userapi.com/c855420/v855420567/1d502d/1LCuve0aDQ8.jpg)
 
Таким образом, мы понимаем, что протокол BGP настроен и работает верно.
 
**Пример с перераспределением маршрутов**


Рассмотрим еще один пример сети с уже настроенным eBGP.
![Net](https://sun9-30.userapi.com/c855420/v855420567/1d503f/DvrLuybg9Ms.jpg)
 
Тут мы видим несколько роутеров, которые являются отдельными автономными системами: AS50500, AS64500, AS64501, AS64502. Между ними настроен eBGP. Кроме того, роутеры с AS50500 и AS64502 соединены с сетями, где BGP не настроен. На обеих из этих сетей настроен OSPF, а также на одной из них работает протокол MPLS. Давайте посмотрим на конфигурации этих роутеров.
Нижний роутер:
 
 ![Нижний](https://sun9-2.userapi.com/c855420/v855420567/1d5047/UMwRBKvbZBs.jpg)

Верхний роутер:

![Верхний](https://sun9-18.userapi.com/c855420/v855420567/1d504e/lvPomuhn6KY.jpg)
 
В них нас интересует параметр redistribute. Он отвечает за перераспределение маршрутов.
Перераспределение маршрутов (route redistribution) — передача маршрутов, выученных с помощью одного протокола маршрутизации, в другой протокол маршрутизации.
Таким образом, сделаем ping к сети интернет, например, с самого верхнего роутера:

![ping](https://sun9-16.userapi.com/c855420/v855420567/1d5056/iih57m3ifCM.jpg)
 

